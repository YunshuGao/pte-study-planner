<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Day Plan — PTE Study Planner</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body>

<nav class="day-nav container">
  <a href="index.html" class="day-nav__btn day-nav__btn--back">&larr; Calendar</a>
  <div class="day-nav__arrows">
    <a id="prevDay" class="day-nav__btn">&larr; Prev</a>
    <a id="nextDay" class="day-nav__btn">Next &rarr;</a>
  </div>
</nav>

<header class="day-header container" id="dayHeader"></header>

<main class="container container--narrow" id="dayContent"></main>

<footer class="site-footer container">
  <a href="index.html" class="btn btn--ghost">&larr; Back to Calendar</a>
</footer>

<script src="js/data.js"></script>
<script>
// ========== CATEGORY MAPPER ==========
function getCatClass(cat) {
  var map = {
    'Read Aloud': 'speaking', 'Repeat Sentence': 'speaking',
    'Describe Image': 'speaking', 'PTE Speaking': 'speaking', 'Warm-up': 'speaking',
    'Write From Dictation': 'writing', 'Essay': 'writing', 'Summarize Written Text': 'writing',
    'Reading': 'reading', 'Listening': 'listening',
    'Review': 'review', 'Grammar': 'review', 'Reflection': 'review', 'Prep': 'review'
  };
  return map[cat] || 'review';
}

// ========== STATE ==========
var state = JSON.parse(localStorage.getItem('pte_planner_v2') || '{}');
if (!state.completed) state.completed = {};
function saveState() { localStorage.setItem('pte_planner_v2', JSON.stringify(state)); }

// ========== GET DAY NUMBER FROM URL ==========
var params = new URLSearchParams(window.location.search);
var dayNum = parseInt(params.get('day')) || 1;
if (dayNum < 1) dayNum = 1;
if (dayNum > 42) dayNum = 42;

var plan = generateDayPlan(dayNum);
document.title = 'Day ' + dayNum + ' — PTE Study Planner';

// ========== NAV LINKS ==========
var prevLink = document.getElementById('prevDay');
var nextLink = document.getElementById('nextDay');
if (dayNum > 1) { prevLink.href = 'day.html?day=' + (dayNum - 1); }
else { prevLink.style.visibility = 'hidden'; }
if (dayNum < 42) { nextLink.href = 'day.html?day=' + (dayNum + 1); }
else { nextLink.style.visibility = 'hidden'; }

// ========== RENDER HEADER ==========
function renderHeader() {
  var header = document.getElementById('dayHeader');

  // Scaffold dots
  var scaffoldLevels = ['full','partial','minimal','none'];
  var scaffoldLabels = ['Full','Partial','Minimal','None'];
  var activeIdx = scaffoldLevels.indexOf(plan.scaffold);
  var dotsHtml = '<div class="scaffold-dots"><span class="scaffold-dots__label">Scaffold:</span>';
  for (var i = 0; i < 4; i++) {
    dotsHtml += '<span class="scaffold-dots__dot' + (i <= activeIdx ? ' scaffold-dots__dot--active' : '') + '" title="' + scaffoldLabels[i] + '"></span>';
  }
  dotsHtml += '</div>';

  // Count tasks for progress ring
  var allTasks = getAllTasks();
  var doneCount = allTasks.filter(function(t) { return state.completed[t.id]; }).length;
  var totalCount = allTasks.length;
  var pct = totalCount ? Math.round(doneCount / totalCount * 100) : 0;
  var circumference = 2 * Math.PI * 36;
  var offset = circumference - (pct / 100) * circumference;

  header.innerHTML = ''
    + '<div class="day-header__date">Day ' + dayNum + ' — ' + plan.dateStr + '</div>'
    + '<div class="day-header__meta">'
    +   '<span class="phase-badge phase-badge--' + plan.phase + '">' + plan.phaseLabel + '</span>'
    +   dotsHtml
    +   '<div class="progress-ring">'
    +     '<svg class="progress-ring__svg" viewBox="0 0 80 80">'
    +       '<circle class="progress-ring__track" cx="40" cy="40" r="36"></circle>'
    +       '<circle class="progress-ring__fill" cx="40" cy="40" r="36" style="stroke-dasharray:' + circumference + ';stroke-dashoffset:' + offset + ';stroke:var(--' + plan.phase + ')"></circle>'
    +     '</svg>'
    +     '<span class="progress-ring__text">' + pct + '%</span>'
    +   '</div>'
    + '</div>'
    + '<p style="color:var(--muted);font-size:0.875rem;margin-top:0.5rem;">' + plan.focusLabel + '</p>';
}

// ========== GET ALL TASKS ==========
function getAllTasks() {
  var tasks = [].concat(
    plan.sections.coreDrills || [],
    plan.sections.writingWorkshop || [],
    plan.sections.pteSpeaking || [],
    plan.sections.readingListening || [],
    plan.sections.review || []
  );
  if (plan.sections.ieltsSpeaking && plan.sections.ieltsSpeaking.part2) {
    tasks.push({id: 'd' + dayNum + '_ielts', cat: 'speaking'});
  }
  return tasks;
}

// ========== RENDER TASK LIST ==========
function renderTaskList(tasks) {
  if (!tasks || tasks.length === 0) return '<p style="color:var(--muted);padding:0.5rem;">No tasks for this section.</p>';
  var html = '<ul class="task-list">';
  tasks.forEach(function(t) {
    var catClass = getCatClass(t.cat);
    var isDone = state.completed[t.id];
    html += '<li class="task task--' + catClass + (isDone ? ' task--done' : '') + '">'
      + '<input type="checkbox" class="task__checkbox" data-id="' + t.id + '"' + (isDone ? ' checked' : '') + '>'
      + '<div class="task__label">'
      +   '<strong>' + t.label + '</strong>'
      +   '<span class="badge badge--' + catClass + '">' + t.cat + '</span>'
      +   (t.time ? '<span class="task__meta">' + t.time + ' min</span>' : '')
      +   '<div style="color:var(--muted);font-size:0.8125rem;margin-top:0.25rem;white-space:pre-line;">' + (t.detail || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</div>'
      + '</div>'
      + '</li>';
  });
  html += '</ul>';
  return html;
}

// ========== RENDER WRITING SCAFFOLDING ==========
function renderWritingScaffolding() {
  var html = '';

  // Writing tip of the day
  if (plan.writingTip) {
    html += '<div class="writing-callout">'
      + '<div class="writing-callout__title">Writing Tip of the Day</div>'
      + '<p>' + plan.writingTip + '</p>'
      + '</div>';
  }

  // Scaffold instructions callout
  if (plan.scaffold !== 'none' && plan.sections.writingWorkshop.length > 0) {
    var scaffoldMsg = SCAFFOLD_INSTRUCTIONS[plan.scaffold].essay;
    html += '<div class="writing-callout">'
      + '<div class="writing-callout__title">Scaffold Level: ' + plan.scaffold.charAt(0).toUpperCase() + plan.scaffold.slice(1) + '</div>'
      + '<p>' + scaffoldMsg + '</p>'
      + '</div>';
  }

  // IBBE Essay Template (shown in full and partial scaffold)
  if (plan.essayTopic && (plan.scaffold === 'full' || plan.scaffold === 'partial')) {
    html += '<div class="writing-area">'
      + '<h4 class="writing-area__heading">Essay Topic</h4>'
      + '<p style="font-weight:600;margin-bottom:0.75rem;font-size:1.0625rem;">' + plan.essayTopic.topic + '</p>'
      + '<span class="badge badge--writing">' + plan.essayTopic.category + '</span>';

    // Show argument hints from prediction bank
    if (plan.essayTopic.hints) {
      html += '<div class="writing-callout" style="margin-top:0.75rem;">'
        + '<div class="writing-callout__title">Argument Ideas (from prediction bank)</div>';
      var hKeys = Object.keys(plan.essayTopic.hints);
      hKeys.forEach(function(hk) {
        html += '<p style="font-size:0.875rem;margin:0.25rem 0;"><strong>' + hk.charAt(0).toUpperCase() + hk.slice(1) + ':</strong> '
          + plan.essayTopic.hints[hk].join(' | ') + '</p>';
      });
      html += '</div>';
    }

    // Show 151-word template in full scaffold
    if (plan.scaffold === 'full' && PTE_TEMPLATES && PTE_TEMPLATES.essay151) {
      html += '<div class="writing-callout" style="margin-top:0.75rem;">'
        + '<div class="writing-callout__title">151-Word Fill-In Template</div>'
        + '<div style="font-size:0.8125rem;white-space:pre-line;font-family:monospace;background:var(--surface);padding:0.75rem;border-radius:0.5rem;">'
        + PTE_TEMPLATES.essay151.para1 + '\n\n' + PTE_TEMPLATES.essay151.para2 + '\n\n' + PTE_TEMPLATES.essay151.para3 + '\n\n' + PTE_TEMPLATES.essay151.para4
        + '</div>'
        + '<p style="font-size:0.75rem;color:var(--muted);margin-top:0.5rem;">' + PTE_TEMPLATES.essay151.tips + '</p>'
        + '</div>';
    }

    // Show IBBE template
    var sections = ['intro','body1','body2','conclusion'];
    var sectionLabels = ['Introduction','Body Paragraph 1','Body Paragraph 2','Conclusion'];

    sections.forEach(function(sec, idx) {
      var tpl = ESSAY_TEMPLATE[sec];
      html += '<div class="writing-area__template">'
        + '<strong>' + sectionLabels[idx] + '</strong>'
        + '<p style="color:var(--muted);font-size:0.8125rem;margin:0.25rem 0 0.5rem;">' + tpl.formula + '</p>';

      // Sentence starters (only in full scaffold)
      if (plan.scaffold === 'full') {
        html += '<div style="margin-bottom:0.5rem;"><strong style="font-size:0.8125rem;">Sentence Starters:</strong><ul style="list-style:disc;padding-left:1.25rem;margin-top:0.25rem;">';
        tpl.starters.forEach(function(s) {
          html += '<li style="font-size:0.8125rem;color:var(--writing);margin-bottom:0.125rem;">' + s + '</li>';
        });
        html += '</ul></div>';
      }

      // Connectors
      html += '<div style="font-size:0.8125rem;"><strong>Connectors:</strong> <span style="color:var(--muted);">' + tpl.connectors.join(' | ') + '</span></div>';
      html += '</div>';
    });

    // Writing area for essay
    html += '<h4 class="writing-area__heading" style="margin-top:1rem;">Your Essay</h4>'
      + '<textarea rows="10" placeholder="Write your essay here... (200-300 words)" data-essay="' + dayNum + '"></textarea>';

    html += '</div>';
  } else if (plan.essayTopic && (plan.scaffold === 'minimal' || plan.scaffold === 'none')) {
    // Minimal/None scaffold: topic + hints + self-assessment
    html += '<div class="writing-area">'
      + '<h4 class="writing-area__heading">Essay Topic' + (plan.essayTopic.ref ? ' <span style="font-size:0.75rem;color:var(--muted);">' + plan.essayTopic.ref + '</span>' : '') + '</h4>'
      + '<p style="font-weight:600;margin-bottom:0.75rem;">' + plan.essayTopic.topic + '</p>'
      + '<span class="badge badge--writing">' + plan.essayTopic.category + '</span>';
    // Show argument hints
    if (plan.essayTopic.hints) {
      html += '<div class="writing-callout" style="margin-top:0.75rem;border-left-color:var(--writing);">'
        + '<div class="writing-callout__title">Argument Ideas</div>';
      var mhKeys = Object.keys(plan.essayTopic.hints);
      mhKeys.forEach(function(mhk) {
        html += '<p style="font-size:0.875rem;margin:0.25rem 0;"><strong>' + mhk.charAt(0).toUpperCase() + mhk.slice(1) + ':</strong> '
          + plan.essayTopic.hints[mhk].join(' | ') + '</p>';
      });
      html += '</div>';
    }
    html += '<div class="writing-callout" style="margin-top:0.75rem;">'
      + '<div class="writing-callout__title">Self-Assessment Checklist</div>'
      + '<ul style="list-style:none;padding:0;font-size:0.875rem;">'
      + '<li>Content: Does my essay address the topic directly?</li>'
      + '<li>Form: Is it 200-300 words?</li>'
      + '<li>Grammar: At least 2 complex sentences per paragraph?</li>'
      + '<li>Vocabulary: Academic word choices, no contractions?</li>'
      + '<li>Spelling: Read backwards word-by-word to catch errors?</li>'
      + '<li>Structure: Clear IBBE structure from memory?</li>'
      + '</ul></div>'
      + '<textarea rows="10" placeholder="Write your essay here... Plan 2 min, Write 15 min, Review 3 min" data-essay="' + dayNum + '"></textarea>'
      + '</div>';
  }

  // SWT scaffold instructions (if SWT day)
  if (plan.swtCount > 0 && plan.scaffold !== 'none') {
    html += '<div class="writing-callout">'
      + '<div class="writing-callout__title">Summarize Written Text Guide</div>'
      + '<p>' + SCAFFOLD_INSTRUCTIONS[plan.scaffold].swt + '</p>'
      + '</div>';
  }

  return html;
}

// ========== RENDER GRAMMAR FOCUS ==========
function renderGrammarFocus() {
  if (!plan.grammarFocus) return '';
  var g = plan.grammarFocus;
  var html = '<div class="grammar-focus">'
    + '<div class="grammar-focus__title">Grammar Focus: ' + g.title + '</div>'
    + '<p class="grammar-focus__rule">' + g.explanation + '</p>';
  g.examples.forEach(function(ex) {
    html += '<div class="grammar-focus__example">'
      + '<div><span style="color:#ef4444;text-decoration:line-through;">' + ex.wrong + '</span></div>'
      + '<div><span style="color:#22c55e;">' + ex.correct + '</span></div>'
      + '</div>';
  });
  html += '</div>';
  return html;
}

// ========== RENDER IELTS SPEAKING ==========
function renderIeltsSpeaking() {
  var ielts = plan.sections.ieltsSpeaking;
  if (!ielts || !ielts.part2) return '';

  var isDone = state.completed['d' + dayNum + '_ielts'];
  var html = '';

  // IELTS task checkbox
  html += '<ul class="task-list"><li class="task task--speaking' + (isDone ? ' task--done' : '') + '">'
    + '<input type="checkbox" class="task__checkbox" data-id="d' + dayNum + '_ielts"' + (isDone ? ' checked' : '') + '>'
    + '<div class="task__label"><strong>IELTS Speaking Practice</strong>'
    + '<span class="badge badge--speaking">Speaking</span>'
    + '<span class="task__meta">15 min</span>'
    + '</div></li></ul>';

  // Speaking scaffold instructions
  if (plan.scaffold !== 'none') {
    html += '<div class="writing-callout" style="border-left-color:var(--speaking);">'
      + '<div class="writing-callout__title" style="color:var(--speaking);">Speaking Scaffold</div>'
      + '<p>' + SCAFFOLD_INSTRUCTIONS[plan.scaffold].speaking + '</p>'
      + '</div>';
  }

  // Part 1
  html += '<div class="speaking-part">'
    + '<h4 class="speaking-part__title">Part 1 — Introduction &amp; Interview</h4>'
    + '<ul class="speaking-part__questions">';
  ielts.part1.forEach(function(q) { html += '<li>' + q + '</li>'; });
  html += '</ul></div>';

  // Part 2 — Cue Card
  html += '<div class="cue-card">'
    + '<div class="cue-card__label">Part 2 — Long Turn (Cue Card)</div>'
    + '<div class="cue-card__topic">' + ielts.part2.topic + '</div>'
    + '<ul class="cue-card__points">';
  ielts.part2.prompts.forEach(function(p) { html += '<li>' + p + '</li>'; });
  html += '</ul>'
    + '<div class="cue-card__time">Prepare: 1 min | Speak: 1-2 min</div>'
    + '</div>';

  // Timer button
  html += '<div style="text-align:center;margin:1rem 0;">'
    + '<button class="timer-btn" id="timerBtn" onclick="toggleTimer()" title="Start 2-minute timer">2:00</button>'
    + '<div class="timer-display" id="timerDisplay" style="display:none;">Time remaining: <span id="timerText">2:00</span></div>'
    + '</div>';

  // Part 3
  html += '<div class="speaking-part">'
    + '<h4 class="speaking-part__title">Part 3 — Two-Way Discussion</h4>'
    + '<ul class="speaking-part__questions">';
  ielts.part3.forEach(function(q) { html += '<li>' + q + '</li>'; });
  html += '</ul></div>';

  // PEEL Framework (shown in full and partial scaffold)
  if (ielts.peelShown) {
    html += '<div class="peel-reference">'
      + '<div class="peel-reference__title">PEEL Framework Reference</div>'
      + '<ul class="peel-reference__list">';
    ['P','E1','E2','L'].forEach(function(key) {
      var item = PEEL_FRAMEWORK[key];
      html += '<li class="peel-reference__item">'
        + '<strong>' + item.label + '</strong>'
        + '<span style="color:var(--muted);font-size:0.8125rem;">' + item.explanation + '</span>';
      if (plan.scaffold === 'full') {
        html += '<em style="display:block;font-size:0.8125rem;color:var(--speaking);margin-top:0.25rem;">"' + item.example + '"</em>';
      }
      html += '</li>';
    });
    html += '</ul></div>';
  }

  return html;
}

// ========== RENDER MAIN CONTENT ==========
function renderContent() {
  var content = document.getElementById('dayContent');
  var html = '';

  // 1. Core Drills Section
  if (plan.sections.coreDrills.length > 0) {
    html += '<details class="section" open>'
      + '<summary class="section__header">'
      + '<span class="section__indicator section__indicator--speaking"></span>'
      + 'Core Drills (RA + RS + WFD)'
      + '<span class="section__chevron">&#9660;</span>'
      + '</summary>'
      + '<div class="section__body">'
      + renderTaskList(plan.sections.coreDrills)
      + '</div></details>';
  }

  // 2. Writing Workshop Section
  if (plan.sections.writingWorkshop.length > 0 || plan.essayTopic || plan.grammarFocus) {
    html += '<details class="section section--writing" open>'
      + '<summary class="section__header">'
      + '<span class="section__indicator section__indicator--writing"></span>'
      + 'Writing Workshop'
      + '<span class="section__chevron">&#9660;</span>'
      + '</summary>'
      + '<div class="section__body">'
      + renderTaskList(plan.sections.writingWorkshop)
      + renderWritingScaffolding()
      + renderGrammarFocus()
      + '</div></details>';
  }

  // 3. IELTS Speaking Section
  if (plan.sections.ieltsSpeaking && plan.sections.ieltsSpeaking.part2) {
    html += '<details class="section section--ielts-speaking" open>'
      + '<summary class="section__header">'
      + '<span class="section__indicator section__indicator--speaking"></span>'
      + 'IELTS Speaking Practice'
      + '<span class="section__chevron">&#9660;</span>'
      + '</summary>'
      + '<div class="section__body">'
      + renderIeltsSpeaking()
      + '</div></details>';
  }

  // 4. PTE Speaking Section
  if (plan.sections.pteSpeaking.length > 0) {
    html += '<details class="section section--pte-speaking">'
      + '<summary class="section__header">'
      + '<span class="section__indicator section__indicator--pte"></span>'
      + 'PTE Speaking Drills'
      + '<span class="section__chevron">&#9660;</span>'
      + '</summary>'
      + '<div class="section__body">'
      + renderTaskList(plan.sections.pteSpeaking)
      + '</div></details>';
  }

  // 5. Reading & Listening Section
  if (plan.sections.readingListening.length > 0) {
    html += '<details class="section section--reading-listening">'
      + '<summary class="section__header">'
      + '<span class="section__indicator section__indicator--reading"></span>'
      + 'Reading &amp; Listening'
      + '<span class="section__chevron">&#9660;</span>'
      + '</summary>'
      + '<div class="section__body">'
      + renderTaskList(plan.sections.readingListening)
      + '</div></details>';
  }

  // 6. Review Section
  if (plan.sections.review.length > 0) {
    html += '<details class="section section--review">'
      + '<summary class="section__header">'
      + '<span class="section__indicator section__indicator--review"></span>'
      + 'Review &amp; Reflection'
      + '<span class="section__chevron">&#9660;</span>'
      + '</summary>'
      + '<div class="section__body">'
      + renderTaskList(plan.sections.review)
      + '</div></details>';
  }

  content.innerHTML = html;

  // Bind checkbox events
  document.querySelectorAll('.task__checkbox').forEach(function(cb) {
    cb.addEventListener('change', function() {
      var id = this.getAttribute('data-id');
      if (this.checked) { state.completed[id] = true; }
      else { delete state.completed[id]; }
      saveState();
      this.closest('.task').classList.toggle('task--done', this.checked);
      renderHeader(); // update progress ring
    });
  });

  // Load saved essay text
  var textarea = document.querySelector('textarea[data-essay]');
  if (textarea) {
    var key = 'pte_essay_' + dayNum;
    textarea.value = localStorage.getItem(key) || '';
    textarea.addEventListener('input', function() {
      localStorage.setItem(key, this.value);
    });
  }
}

// ========== TIMER ==========
var timerInterval = null;
var timerSeconds = 120;

function toggleTimer() {
  var btn = document.getElementById('timerBtn');
  var display = document.getElementById('timerDisplay');
  var text = document.getElementById('timerText');

  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
    btn.classList.remove('timer-btn--active');
    btn.textContent = '2:00';
    display.style.display = 'none';
    timerSeconds = 120;
    return;
  }

  timerSeconds = 120;
  btn.classList.add('timer-btn--active');
  display.style.display = 'block';
  updateTimerDisplay();

  timerInterval = setInterval(function() {
    timerSeconds--;
    if (timerSeconds <= 0) {
      clearInterval(timerInterval);
      timerInterval = null;
      btn.classList.remove('timer-btn--active');
      btn.textContent = 'Done!';
      text.textContent = '0:00';
      btn.style.background = 'var(--speaking)';
      setTimeout(function() { btn.style.background = ''; btn.textContent = '2:00'; display.style.display = 'none'; }, 3000);
      return;
    }
    updateTimerDisplay();
  }, 1000);
}

function updateTimerDisplay() {
  var min = Math.floor(timerSeconds / 60);
  var sec = timerSeconds % 60;
  var str = min + ':' + (sec < 10 ? '0' : '') + sec;
  document.getElementById('timerBtn').textContent = str;
  document.getElementById('timerText').textContent = str;
}

// ========== INIT ==========
renderHeader();
renderContent();
</script>
</body>
</html>
